# README

## /r/Pikabu

**Лига Киборгов** представляет:
Теперь у каждого имеется возможность стать человеческим организмом, усиленным робототехническими аугументациями и кибернетическими имплантами.

Робототехнические аугументации позволят ускорить рутиные операции взаимодействия с окружением, (например, теперь можно автоматически посылать в ответ любого пославшего), позволяя существенно ускорить собственные возможности.

Кибернетические имплантаты позволят произвести быстрый анализ окружения и сообщить необходимую информацию, без непосредственного взаимодействия с окружением (например, можно быстро узнать о концетрации посыланий в определённых местах, благодаря появлению соответствующих сообщений в личке, что позволит быстро присоединиться к вечеринке).

## Имплантат: инфосканер


## Эксплуатация

#### Windows

Необходимо скачать для Windows архив:
 - [implant-infoscaner_1.1.0.zip](https://github.com/IarcaniusI/implant-infoscaner/files/4950209/implant-infoscaner_1.1.0.zip)

После разархивации в каталоге должен находиться:
 - ```implant-infoscaner.exe``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключения;
 - ```run.conf``` - файл с настройками выражений и ответов на них;
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Для запуска достаточно запустить ```.exe``` файл, с расположенными рядом и подстроенными ```auth.conf``` и ```run.conf```. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как бинарный файл

Необходимо скачать для Linux архив:
 - [implant-infoscaner_amd64_1.1.0.tar.gz](https://github.com/IarcaniusI/implant-infoscaner/files/4950162/implant-infoscaner_amd64_1.1.0.tar.gz)

После разархивации в каталоге должен находиться:
 - ```implant-infoscaner``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключенияж
 - ```run.conf``` - файл с настройками выражений и ответов на нихж
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Исполняемый файл ```implant-infoscaner``` имеет следующие аргументы командной строки:
 - ```-h```, ```--help``` - справка с описанием аргументов;
 - ```-r```, ```--run``` ```RUNFILE``` - путь до файла с настройками выражений (по умолчанию ```./run.conf```);
 - ```-a```, ```--auth``` ```AUTHFILE``` - путь до файла с настройками подключения (по умолчанию ```./auth.conf```);
 - ```-n```, ```--no-notify``` - отключить сообщения о событиях и ответах (например, для экономии места на диске для логов);

При запуске без аргументов конфигурационные файлы должны находиться рядом с бинарным. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как сервис для supervisord

Предварительно должны быть установлены пакеты:
 - [python3](https://www.python.org/)
 - [supervisor](http://supervisord.org/)

Требуется установить следующие модули для ```Python 3```:
 - ```praw```
 - ```prawcore```

Выкачиваем репозиторий, после чего раскладываем файлы следующим образом:
 - ```implant-infoscaner.py``` в каталог ```/usr/local/bin/```
 - ```run.conf``` и ```auth.conf``` в каталог ```/usr/local/etc/implant-infoscaner/```
 - ```implant-infoscaner.conf``` в каталог ```/etc/supervisor/conf.d/```

В описанном файле ```implant-infoscaner.conf``` предполагается запуск сервиса от пользователя ```cyborg```. 
Поэтому для успешной работы необходимо сделать одно из следующих действий:
 - создать в системе пользователя с именем ```cyborg```;
 - изменить в файле ```implant-infoscaner.conf``` значение переменной ```user``` на имя существующего пользователя.

Добавляем новообразовавшийся сервис путём выполнения следующих команд:
```
supervisorctl reread
supervisorctl add implant-infoscaner
```

Посмотреть на статус сервисов можно командой:
```
supervisorctl status
```

Произвести запуск, остановку и перезапуск сервиса для пересчитывания конфигов можно с помошью следующих команд:
```
supervisorctl start implant-infoscaner
supervisorctl stop implant-infoscaner
supervisorctl restart implant-infoscaner
```

Логи будут писаться через ```rsyslog```, как правило это делается в файл ```/var/log/syslog```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

## Настройка соединения

Сперва необходимо дать Reddit сгенерировать ключ. Для этого требуется:
1. Зайти в свой аккаунт на Reddit и перейти по ссылке [www.reddit.com/prefs/apps](https://www.reddit.com/prefs/apps);
1. Нажать кнопку ```Create another app...``` (```Создать другое приложение...```);
1. В поле ```name``` (```имя```) вбить название, к примеру ```auguments-and-implants```;
1. Выбрать переключатель ```script``` (```сценарий```);
1. В поле ```redirect uri``` (```uri переадресации```) вбить ссылку для перенаправления, например [www.example.com/unused/redirect/uri](http://www.example.com/unused/redirect/uri);
1. По желанию заполнить поля ```description``` (```описание```) и ```about url``` (```о url```);
1. Нажать кнопку ```create app``` (```создать приложение```);
1. Из появившейся карточки необходимо скопировать:
    - ID, расположенный под надписью ```personal use script``` (```скрипт для личного пользования```);
    - секретный ключ, расположенный рядом с надписью ```secret``` (```секрет```).

После того как данная последовательность действий выполнена, полученными настройками можно пользоваться и для других обработчиков.

Теперь необходимо занести соответствующие настройки в ```auth.conf``` файл. Пример файла:
```
{
    "user_agent": "implant-infoscaner (/u/myuser)",
    "client_id": "braEnm4E3V9D01",
    "client_secret": "3F9dfp2_CspmeVd81Dkepvnwl3D",
    "username": "myuser",
    "password": "mypassword",
    "subreddit": "Pikabu"
}
```
Здесь в настройках указывается:
 - ```user_agent``` - общее имя программы и имя пользователя;
 - ```client_id``` - ID, скопированный ранне;
 - ```client_secret``` - секретный ключ, скопированный ранее;
 - ```username``` - имя пользователя;
 - ```password``` - пароль, для входа в аккаунт;
 - ```subreddit``` - название саба, к которому происходит подключение;

## Составление правил

Правила описываются в файле ```run.conf```. Рассмотреть составление правил можно на следующем примере:
```
[
    {
        "scanner_regexes": ["(динозавр|диназавр)", "(нефть|нефти)"],
        "theme": "геология"
    },
    {
        "scanner_regexes": ["(кот|кошка|котэ)"],
        "theme": "коты"
    },
    {
        "scanner_regexes": ["(@moder|@moderator|@admin)"],
        "theme": "moderation",
        "subscribers": ["Podonok", "moder1", "moder2"]
    }
]
```

В примере присутствуют 2 правила, заключённых в фигурные скобки.
У каждого правила присутствует список ```reply_regexes```, хранящий список фраз, которые должны быть найденны в комментарии, чтобы на него был дан ответ.
Порядок фраз не важен, важно наличие каждой из них, поэтому в данном примере предложения "динозавры сделаны из нефти" и "нефть образовалась из динозавров" одинаково подходят.
Однако если в коменте не встречается хотя бы одна из фраз (например, как в комменте "барель нефти подешевел", где отсутствует "динозавр" или "динозавр"), коммент считается не подходящим по данному правилу.

Должны быть обнаружены все описанные в правиле фразы в сформулированном виде, но при этом они могут быть найдены в составе других слов.
Например фразы "кот", "котик" и "икота" одинако подходят под второе правило.
Также в правиле в параметре ```theme``` указывается тема правила, описывающая примерное содержание рассматриваемого сообщения.
Когда один из написанных в сабе комментов совпадёт с один из правил, придёт личное сообщение,
в тексте которого будет написанный комментарий и ссылка на коммент, а в заголовке фраза ```THEME xxx DETECTED```, где вместо ```xxx``` указывается тема найденного сообщения.

Существует также необязательныйы аргумент ```subscribers```. С помощью него указывается список пользователей, которым должно прийти абсолютно аналогичное личное сообщение.
Данный функционал удобен, в случае когда держать компьютер постоянно включённым имеет возможность только один пользователь, но многим другим также требуется получать такие же оповещения.
В приведённом примере фразы ```@moder```, ```@moderator```, ```@moderation``` будут вызывать рассылку сообщений как на текущий аккаунт,
так и на аккаунты пользователей "@Podonok", "moder1" и "moder2". В данном случае слово ```@moderator``` можно было не указывать в правиле, так как оно и так бы искалось при
поиске ```@moder```, однако такая запись может помочь сделать правила более читаемыми.

В ```scanner_regexes``` можно использовать регулярные выражении.
При использовании регулярных выражений экранирование должно выполяться двойным обратным слешем ```\\```, а не одинарным.


## Разработчикам

### Компиляция

Для компиляции необходимо установить модули для ```Python3```:
 - ```pyinstaller```

Для сборки выполняем команду:
```
pyinstaller ./implant-infoscaner.py --onefile
```

Бинарный файл будет распологаться в новосозданном каталоге ```dist```.
После сборки можно удалить как ненужные следующие объекты:
- каталог ```__pycache__```;
- каталог ```build```;
- каталог ```dist```;
- файлы с расширением ```.spec```.

Рядом с получившимся бинарным файлом необходимо рядом положить файл ```praw.ini```, поставляемый вместе с модулем ```praw```.
